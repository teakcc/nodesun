"use strict";function _interopDefault(t){return t&&"object"==typeof t&&"default"in t?t.default:t}var path=_interopDefault(require("path")),program=_interopDefault(require("commander")),chalk=_interopDefault(require("chalk")),cluster=_interopDefault(require("cluster")),fs=_interopDefault(require("fs"));function fsExists(t,r){!path.extname(t)&&r&&(t+=r);try{fs.accessSync(t)}catch(t){return!1}return!0}var Watcher=function(){function t(t){var r=this;this.rootPath=t.rootPath,this.watch=t.watch,this.watchExt=".js",this.exclude=/node_modules/,this.handler=t.handler;var e=this.rootPath;if("string"==typeof this.watch&&/^\[.*\]$/.test(this.watch)&&(console.log(""+chalk.red("--watch arguments only support string from CLI, example: --watch ./foo")),process.exit(0)),"string"==typeof this.watch){if(/^(\.|\*|\*\.js)$/.test(this.watch)||(e=path.resolve(this.rootPath,this.watch)),!fsExists(e))return void console.log(chalk.red.bold(e)+" "+chalk.red("is not exists"));this.watchFiles(e)}Array.isArray(this.watch)&&this.watch.forEach(function(t){fsExists(e=path.resolve(r.rootPath,t))?r.watchFiles(e):console.log(chalk.red.bold(e)+" "+chalk.red("is not exists"))})}return t.prototype.watchFiles=function(o){var s=this;fs.readdir(o,function(t,r){r.forEach(function(t){if(!s.exclude.test(t)){var r=path.resolve(o,t),e=fs.lstatSync(r);e.isDirectory()&&s.watchFiles(r),e.isFile()&&-1!==s.watchExt.indexOf(path.extname(r))&&fs.watch(r,function(){s.handler&&s.handler()})}})})},t}(),isMaster=cluster.isMaster,isWorker=cluster.isWorker,Deamon=function(){function t(t){this.rootPath=t.rootPath,this.entry=t.entry,this.watch=t.watch,this.debug=t.debug;try{this.startWorkers()}catch(t){}}return t.prototype.startWorkers=function(){var o=this,t=this,r=void 0;isMaster&&(cluster.setupMaster({silent:!1}),this.forkProcess(1),r&&void 0!==r&&(r=void 0),r=new Watcher({rootPath:this.rootPath,watch:this.watch,handler:function(){t.restartWorkers.call(t)}}),cluster.on("online",function(t){o.debug&&console.log(chalk.green("worker")+" "+chalk.green.bold(t.process.pid)+" is online")}),cluster.on("exit",function(t,r,e){o.debug&&console.log(chalk.red("worker")+" "+chalk.red.bold(t.process.pid)+" is died"),cluster.fork()})),isWorker&&(Promise.resolve(require(this.entry)).catch(function(t){console.log(t)}),process.on("message",function(t){"shutdown"===t.type&&process.exit(0)}))},t.prototype.forkProcess=function(t){for(var r=0;r<t;)cluster.fork(),r++},t.prototype.restartWorkers=function(){var t,r=[];for(t in cluster.workers)r.push(t);try{r.forEach(function(t){cluster.workers[t].send({type:"shutdown",from:"master"}),setTimeout(function(){cluster.workers[t]&&cluster.workers[t].kill("SIGKILL")},3e3)})}catch(t){console.log(t)}},t}(),ROOT_PATH=process.cwd(),Obbo=function(){function t(t){this.version=t.version,this.debug=t.debug}return t.prototype.showBanner=function(){console.log("Hello, I am OBBO!"),console.log("version: "+this.version)},t.prototype.initProgram=function(){var o=this.debug;program.version(this.version),program.command("start <entry>").description("start a application from entry file").option("-w, --watch [paths]","watch application folder for changes, default is project root dir").action(function(t,r){var e=r.watch;void 0!==e&&!0!==e||(e="."),fsExists(t=path.resolve(ROOT_PATH,t),".js")?new Deamon({rootPath:ROOT_PATH,entry:t,watch:e,debug:o}):console.log(chalk.red.bold(t)+" "+chalk.red("is not exists, you must provide a entry file or insure a index.js file in your project root directory"))}),program.parse(process.argv),0===program.args.length&&program.help()},t.prototype.run=function(){this.initProgram()},t}();module.exports=Obbo;
