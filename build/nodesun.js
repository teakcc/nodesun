"use strict";function _interopDefault(t){return t&&"object"==typeof t&&"default"in t?t.default:t}var path=_interopDefault(require("path")),program=_interopDefault(require("commander")),chalk=_interopDefault(require("chalk")),cluster=_interopDefault(require("cluster")),chokidar=_interopDefault(require("chokidar")),fs=_interopDefault(require("fs")),Watcher=function(){function t(t){this.rootPath=t.rootPath,this.watch=t.watch,this.watchExt=".js",this.exclude=/node_modules/,this.handler=t.handler,console.log("---- this.watch"),console.log(this.watch),"string"==typeof this.watch&&/^\[.*\]$/.test(this.watch)?this.watchFiles(this.watch):"string"==typeof this.watch&&this.watchFiles(this.watch)}return t.prototype.watchFiles=function(t){var r=this;chokidar.watch(t,{ignored:/node_modules/,persistent:!0,interval:800}).on("all",function(t,e){console.log(t,e),console.log(chalk.green("file "+chalk.bold(e)+" "+t+"...")),r.handler()})},t}(),isMaster=cluster.isMaster,isWorker=cluster.isWorker,Deamon=function(){function t(t){this.rootPath=t.rootPath,this.entry=t.entry,this.watch=t.watch,this.debug=t.debug,this.watcher=null;try{this.startWorkers()}catch(t){}}return t.prototype.startWorkers=function(){var o=this;isMaster&&(cluster.setupMaster({silent:!1}),this.forkProcess(1),this.createWatcherInstance(),cluster.on("online",function(t){o.debug&&console.log(chalk.green("worker")+" "+chalk.green.bold(t.process.pid)+" is online")}),cluster.on("exit",function(t,e,r){o.debug&&console.log(chalk.red("worker")+" "+chalk.red.bold(t.process.pid)+" is died"),cluster.fork()})),isWorker&&(Promise.resolve(require(this.entry)).catch(function(t){console.log(t)}),process.on("message",function(t){"shutdown"===t.type&&process.exit(0)}))},t.prototype.forkProcess=function(t){for(var e=0;e<t;)cluster.fork(),e++},t.prototype.createWatcherInstance=function(){var t=this;this.watcher&&(this.watcher=null),this.watcher=new Watcher({rootPath:this.rootPath,watch:this.watch,handler:function(){t.restartWorkers.call(t)}})},t.prototype.restartWorkers=function(){var t=[];for(var e in cluster.workers)cluster.workers.hasOwnProperty(e)&&t.push(e);try{t.forEach(function(t){cluster.workers[t].send({type:"shutdown",from:"master"}),setTimeout(function(){cluster.workers[t]&&cluster.workers[t].kill("SIGKILL")},3e3)})}catch(t){console.log(t)}},t}();function fsExists(t,e){!path.extname(t)&&e&&(t+=e);try{fs.accessSync(t)}catch(t){return!1}return!0}var ROOT_PATH=process.cwd(),NodeSun=function(){function t(t){this.version=t.version,this.debug=t.debug}return t.prototype.showBanner=function(){console.log("Hello, I am NodeSun!"),console.log("version: "+this.version)},t.prototype.initProgram=function(){var o=this.debug;program.version(this.version),program.command("start <entry>").description("start a application from entry file").option("-w, --watch [paths]","watch application folder for changes, default is project root dir").action(function(t,e){var r=e.watch;void 0!==r&&!0!==r||(r="**/*.js"),fsExists(t=path.resolve(ROOT_PATH,t),".js")?new Deamon({rootPath:ROOT_PATH,entry:t,watch:r,debug:o}):console.log(chalk.red.bold(t)+" "+chalk.red("is not exists, you must provide a entry file or insure a index.js file in your project root directory"))}),program.parse(process.argv),0===program.args.length&&program.help()},t.prototype.run=function(){this.initProgram()},t}();module.exports=NodeSun;
